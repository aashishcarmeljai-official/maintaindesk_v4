{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <h1 class="h3 mb-3">Meter Analytics</h1>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label for="meterSelect" class="form-label">Select a Meter to Monitor</label>
                    <select id="meterSelect" class="form-select">
                        <option value="">-- Select a Meter --</option>
                        {% for meter in meters %}
                        <option value="{{ meter.mqtt_topic }}">{{ meter.name }} ({{ meter.equipment.name if meter.equipment }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <p class="mb-2"><strong>Connection Status:</strong> 
                        <span id="status-indicator" class="badge bg-secondary">Not Connected</span>
                    </p>
                    <p class="mb-0"><strong>Subscribed Topic:</strong> 
                        <code id="topic-display">N/A</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h5 class="mb-0">Real-time Data Log</h5></div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-sm table-striped">
                    <thead id="log-table-head" class="table-header-sticky">
                        <!-- Table headers will be generated by JS -->
                    </thead>
                    <tbody id="log-table-body">
                        <tr><td class="text-center text-muted p-4" colspan="10">Waiting for data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- TomSelect for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<!-- Socket.IO client library -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- TomSelect Initialization ---
    // Make the meter dropdown searchable
    const tomSelect = new TomSelect('#meterSelect', {
        create: false,
        placeholder: 'Search and select a meter...'
    });
    
    // --- WebSocket Logic ---
    const socket = io();
    const statusIndicator = document.getElementById('status-indicator');
    const topicDisplay = document.getElementById('topic-display');
    // We get the select element directly, not the TomSelect instance, for the event listener
    const meterSelect = document.getElementById('meterSelect'); 
    const logTableHead = document.getElementById('log-table-head');
    const logTableBody = document.getElementById('log-table-body');
    let isFirstMessage = true;

    socket.on('connect', () => {
        statusIndicator.textContent = 'Connected';
        statusIndicator.className = 'badge bg-success';
        console.log('Socket.IO connected!');
    });

    socket.on('disconnect', () => {
        statusIndicator.textContent = 'Disconnected';
        statusIndicator.className = 'badge bg-danger';
        console.log('Socket.IO disconnected.');
    });

    socket.on('mqtt_message', (data) => {
        // ... (this part of the logic is correct and unchanged) ...
        console.log('Received MQTT message:', data);
        if (isFirstMessage) {
            logTableBody.innerHTML = '';
            const headers = Object.keys(data);
            const headerRow = document.createElement('tr');
            headers.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key.charAt(0).toUpperCase() + key.slice(1);
                headerRow.appendChild(th);
            });
            logTableHead.innerHTML = '';
            logTableHead.appendChild(headerRow);
            isFirstMessage = false;
        }
        const newRow = document.createElement('tr');
        Object.values(data).forEach(value => {
            const td = document.createElement('td');
td.textContent = value;
            newRow.appendChild(td);
        });
        logTableBody.prepend(newRow);
    });

    // Handle dropdown change
    meterSelect.addEventListener('change', function() {
        const selectedTopic = this.value;
        logTableBody.innerHTML = '<tr><td class="text-center text-muted p-4" colspan="10">Waiting for data...</td></tr>';
        logTableHead.innerHTML = '';
        isFirstMessage = true;
        
        if (selectedTopic) {
            socket.emit('subscribe', { topic: selectedTopic });
            topicDisplay.textContent = selectedTopic;
        } else {
            socket.emit('unsubscribe');
            topicDisplay.textContent = 'N/A';
        }
    });
});
</script>
{% endblock %}